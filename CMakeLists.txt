cmake_minimum_required(VERSION 3.12)
project(pdf_convert)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–∞–∑—Ä—è–¥–Ω–æ—Å—Ç—å
if(CMAKE_SIZEOF_VOID_P EQUAL 8)
    set(ARCH_BITS 64)
    message(STATUS "üîç Detected 64-bit architecture")
else()
    set(ARCH_BITS 32)
    message(FATAL_ERROR "üîç Detected 32-bit architecture")
endif()


# --- LOCAL MuPDF CONFIGURATION ---
if(MSYS OR MINGW OR CYGWIN OR CMAKE_HOST_WIN32)
    message(STATUS "üéØ Detected Windows environment")
    set(MUPDF_PLATFORM "windows")
    # –ö–æ—Ä–Ω–µ–≤–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è MuPDF
    set(MUPDF_ROOT ${CMAKE_SOURCE_DIR}/mupdf-source-windows)
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ
    set(MUPDF_BUILD_DIR ${MUPDF_ROOT}/build/release)
    set(MUPDF_LIBRARY ${MUPDF_BUILD_DIR}/libmupdf.a)  # –í MinGW –æ–±—ã—á–Ω–æ .a, –¥–∞–∂–µ –Ω–∞ Windows
    # –ü—É—Ç—å –∫ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º
    set(MUPDF_INCLUDE_DIR ${MUPDF_ROOT}/include)
elseif(UNIX AND NOT APPLE)
    message(STATUS "üéØ Detected Linux environment")
    set(MUPDF_PLATFORM "linux")
    # –ö–æ—Ä–Ω–µ–≤–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è MuPDF
    set(MUPDF_ROOT ${CMAKE_SOURCE_DIR}/mupdf-source-linux)
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ
    set(MUPDF_BUILD_DIR ${MUPDF_ROOT}/build/release)
    set(MUPDF_LIBRARY ${MUPDF_BUILD_DIR}/libmupdf.a)
    # –ü—É—Ç—å –∫ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º
    set(MUPDF_INCLUDE_DIR ${MUPDF_ROOT}/include)
elseif(APPLE)
    message(STATUS "üéØ Detected macOS environment")
    set(MUPDF_PLATFORM "macos")
    # ... –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è macOS
else()
    message(FATAL_ERROR "‚ùå Unsupported platform")
endif()

message(STATUS "üìÅ MuPDF root: ${MUPDF_ROOT}")

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ MuPDF
if(NOT EXISTS ${MUPDF_ROOT})
    message(FATAL_ERROR "‚ùå MuPDF not found at ${MUPDF_ROOT}")
endif()

if(NOT EXISTS ${MUPDF_LIBRARY})
    message(FATAL_ERROR "‚ùå MuPDF library not built at ${MUPDF_LIBRARY}")
endif()

message(STATUS "‚úÖ Using local MuPDF:")
message(STATUS "   Platform: ${MUPDF_PLATFORM}")
message(STATUS "   Root: ${MUPDF_ROOT}")
message(STATUS "   Include: ${MUPDF_INCLUDE_DIR}")
message(STATUS "   Library: ${MUPDF_LIBRARY}")

# –°–æ–∑–¥–∞–µ–º –∫–∞—Ç–∞–ª–æ–≥ bin
file(MAKE_DIRECTORY ${CMAKE_SOURCE_DIR}/bin)
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_SOURCE_DIR}/bin)

# –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –∏—Å—Ö–æ–¥–Ω–∏–∫–∏
set(SOURCES
    main.cpp
    validators.cpp
    # Convert handler
    handlers/convert_to_img/handler.cpp
    handlers/convert_to_img/rules.cpp
    # Help handler
    handlers/help/handler.cpp
    handlers/help/rules.cpp
    # Test handler
    handlers/test/handler.cpp
    handlers/test/rules.cpp
)

include_directories(
    ${CMAKE_SOURCE_DIR}
    ${MUPDF_INCLUDE_DIR}
    ${CMAKE_SOURCE_DIR}/handlers/convert_to_img  # –î–ª—è #include "dto.h"
    ${CMAKE_SOURCE_DIR}/handlers/help  # –î–ª—è #include "dto.h"
    ${CMAKE_SOURCE_DIR}/handlers/test  # –î–ª—è #include "dto.h"
)

add_executable(pdf_convert ${SOURCES})

# –õ–∏–Ω–∫—É–µ–º —Å MuPDF –∏ —Å–∏—Å—Ç–µ–º–Ω—ã–º–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞–º–∏
if(MUPDF_PLATFORM STREQUAL "windows")
    # –î–ª—è Windows (MinGW)
    message(STATUS "üîó Linking for Windows (MinGW)")
    target_link_libraries(pdf_convert 
        # –û—Å–Ω–æ–≤–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ MuPDF
        ${MUPDF_LIBRARY}
        
        # –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ MuPDF (–µ—Å–ª–∏ –µ—Å—Ç—å)
        ${MUPDF_BUILD_DIR}/libmupdf-third.a
        ${MUPDF_BUILD_DIR}/libmupdf-threads.a
        
        # –°–∏—Å—Ç–µ–º–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ Windows
        gdi32
        user32
        shell32
        advapi32

        ws2_32
        comdlg32
        
        # # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
        # zlibstatic  # –∏–ª–∏ zlib –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –ª–∏–Ω–∫–æ–≤–∫–∏
        # lcms2
        # libjpeg
        # openjp2
        # jbig2dec
        # gumbo
        # freetype
        # harfbuzz
    )
elseif(MUPDF_PLATFORM STREQUAL "linux")
    # –î–ª—è Linux
    message(STATUS "üîó Linking for Linux")
    target_link_libraries(pdf_convert 
        # –û—Å–Ω–æ–≤–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ MuPDF
        ${MUPDF_LIBRARY}
        
        # –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ MuPDF (–µ—Å–ª–∏ –µ—Å—Ç—å)
        ${MUPDF_BUILD_DIR}/libmupdf-third.a
        ${MUPDF_BUILD_DIR}/libmupdf-threads.a
        
        # –°–∏—Å—Ç–µ–º–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
        m          # libm
        pthread    # libpthread
        
        # –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç MuPDF
        z          # zlib
        lcms2      # Little CMS
        jpeg       # JPEG
        openjp2    # OpenJPEG
        jbig2dec   # JBIG2
        gumbo      # HTML parser
        freetype   # FreeType
        harfbuzz   # HarfBuzz
        crypto     # OpenSSL
    )
endif()

# –í—ã–≤–æ–¥–∏–º –∏—Ç–æ–≥–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
message(STATUS "")
message(STATUS "üéä Configuration summary:")
message(STATUS "   Project: ${PROJECT_NAME}")
message(STATUS "   Platform: ${CMAKE_SYSTEM_NAME}")
message(STATUS "   Architecture: ${ARCH_BITS}-bit")
message(STATUS "   Output: ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/${PROJECT_NAME}")
message(STATUS "")